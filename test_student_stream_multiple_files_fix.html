<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Student Stream Multiple Files Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
        }
        .post {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #007bff;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .post-info {
            flex: 1;
        }
        .user-name {
            font-weight: bold;
            color: #333;
        }
        .post-time {
            color: #666;
            font-size: 0.9em;
        }
        .post-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }
        .post-content {
            color: #555;
            margin-bottom: 15px;
        }
        .attachments {
            margin-top: 15px;
        }
        .attachment {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .attachment-icon {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }
        .attachment-info {
            flex: 1;
        }
        .attachment-name {
            font-weight: bold;
            color: #333;
        }
        .attachment-details {
            color: #666;
            font-size: 0.9em;
        }
        .attachment-download {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }
        .attachment-download:hover {
            text-decoration: underline;
        }
        .multiple-attachments {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .single-attachment {
            background-color: #f3e5f5;
            border: 1px solid #9c27b0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .no-attachment {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Student Stream Multiple Files Fix</h1>
        <p>This test verifies that the student stream API now properly returns multiple attachments.</p>
        
        <div class="form-group">
            <label for="classCode">Class Code:</label>
            <input type="text" id="classCode" value="PA3RUJ" placeholder="Enter class code">
        </div>
        
        <div class="form-group">
            <label for="studentToken">Student JWT Token:</label>
            <input type="text" id="studentToken" placeholder="Enter student JWT token">
        </div>
        
        <button onclick="testStreamAPI()">Test Stream API</button>
        <button onclick="clearResponse()">Clear Response</button>
        
        <div id="response" class="response" style="display: none;"></div>
    </div>
    
    <div id="postsContainer" class="container" style="display: none;">
        <h2>Stream Posts with Attachments</h2>
        <div id="postsList"></div>
    </div>
    
    <script>
        const BASE_URL = 'http://localhost/scms_new_backup';
        
        async function testStreamAPI() {
            const classCode = document.getElementById('classCode').value;
            const studentToken = document.getElementById('studentToken').value;
            
            if (!studentToken) {
                alert('Please enter a student JWT token');
                return;
            }
            
            if (!classCode) {
                alert('Please enter a class code');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/index.php/api/student/classroom/${classCode}/stream`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${studentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                const responseDiv = document.getElementById('response');
                responseDiv.style.display = 'block';
                responseDiv.textContent = JSON.stringify(result, null, 2);
                
                if (result.status) {
                    displayPosts(result.data);
                } else {
                    alert('Error: ' + result.message);
                }
                
            } catch (error) {
                console.error('Error:', error);
                const responseDiv = document.getElementById('response');
                responseDiv.style.display = 'block';
                responseDiv.textContent = 'Network Error: ' + error.message;
            }
        }
        
        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            const postsList = document.getElementById('postsList');
            
            container.style.display = 'block';
            postsList.innerHTML = '';
            
            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                
                // Profile picture (first letter of user name)
                const profilePic = post.profile_pic ? 
                    `<img src="${BASE_URL}/${post.profile_pic}" alt="Profile" style="width: 40px; height: 40px; border-radius: 50%;">` :
                    `<div class="profile-pic">${post.user_name.charAt(0)}</div>`;
                
                // Attachment display
                let attachmentHtml = '';
                if (post.attachment_type === 'multiple' && post.attachments && post.attachments.length > 0) {
                    attachmentHtml = `
                        <div class="multiple-attachments">
                            <strong>Multiple Attachments (${post.attachments.length}):</strong>
                            ${post.attachments.map(attachment => `
                                <div class="attachment">
                                    <div class="attachment-icon" style="background-color: #2196f3;">
                                        ${getFileTypeIcon(attachment.mime_type)}
                                    </div>
                                    <div class="attachment-info">
                                        <div class="attachment-name">${attachment.original_name}</div>
                                        <div class="attachment-details">
                                            ${formatFileSize(attachment.file_size)} â€¢ ${attachment.mime_type}
                                        </div>
                                    </div>
                                    <a href="${attachment.serving_url}" class="attachment-download" target="_blank">
                                        Download
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else if (post.attachment_url) {
                    const fileType = post.attachment_file_type || 'unknown';
                    attachmentHtml = `
                        <div class="single-attachment">
                            <strong>Single Attachment:</strong>
                            <div class="attachment">
                                <div class="attachment-icon" style="background-color: #9c27b0;">
                                    ${getFileTypeIcon(fileType)}
                                </div>
                                <div class="attachment-info">
                                    <div class="attachment-name">${post.attachment_url.split('/').pop()}</div>
                                    <div class="attachment-details">${fileType}</div>
                                </div>
                                <a href="${post.attachment_serving_url || post.attachment_url}" class="attachment-download" target="_blank">
                                    Download
                                </a>
                            </div>
                        </div>
                    `;
                } else {
                    attachmentHtml = '<div class="no-attachment">No attachments</div>';
                }
                
                postDiv.innerHTML = `
                    <div class="post-header">
                        ${profilePic}
                        <div class="post-info">
                            <div class="user-name">${post.user_name}</div>
                            <div class="post-time">${formatTime(post.created_at)}</div>
                        </div>
                    </div>
                    <div class="post-title">${post.title}</div>
                    <div class="post-content">${post.content}</div>
                    ${attachmentHtml}
                    <div style="margin-top: 15px; color: #666;">
                        Comments: ${post.comment_count} | 
                        Attachment Type: ${post.attachment_type}
                    </div>
                `;
                
                postsList.appendChild(postDiv);
            });
        }
        
        function getFileTypeIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'IMG';
            if (mimeType.startsWith('video/')) return 'VID';
            if (mimeType.startsWith('audio/')) return 'AUD';
            if (mimeType.includes('pdf')) return 'PDF';
            if (mimeType.includes('word') || mimeType.includes('document')) return 'DOC';
            if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return 'XLS';
            if (mimeType.includes('powerpoint') || mimeType.includes('presentation')) return 'PPT';
            if (mimeType.includes('zip') || mimeType.includes('rar')) return 'ZIP';
            return 'FILE';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }
        
        function clearResponse() {
            document.getElementById('response').style.display = 'none';
            document.getElementById('postsContainer').style.display = 'none';
        }
    </script>
</body>
</html>
