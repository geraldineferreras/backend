<!DOCTYPE html>
<html>
<head>
    <title>SSE Complete Test - Browser</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log { 
            background: #f0f0f0; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 3px; 
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        input, button, select { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-weight: bold;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Complete SSE Test - Browser</h1>
        
        <div class="input-group">
            <label for="baseUrl">Deployed Application URL:</label>
            <input type="text" id="baseUrl" placeholder="https://your-app.railway.app" style="width: 100%;">
        </div>
        
        <div class="input-group">
            <label for="token">JWT Token:</label>
            <input type="text" id="token" placeholder="Enter your JWT token from login" style="width: 100%;">
        </div>
        
        <div class="input-group">
            <label for="userId">User ID:</label>
            <input type="text" id="userId" placeholder="STU001" value="STU001" style="width: 200px;">
        </div>
        
        <div class="grid">
            <!-- Left Column: SSE Testing -->
            <div class="section">
                <h3>üì° SSE Stream Testing</h3>
                <div>
                    <button onclick="testSSE()" id="sseBtn">üîå Connect to SSE</button>
                    <button onclick="disconnectSSE()" id="disconnectBtn" disabled>‚ùå Disconnect</button>
                    <button onclick="clearSSELog()">üóëÔ∏è Clear Log</button>
                </div>
                
                <div id="sseStatus" class="status disconnected">‚ùå Not Connected</div>
                <div id="sseLog" class="log">Ready to connect to SSE stream...</div>
            </div>
            
            <!-- Right Column: Notification Creation -->
            <div class="section">
                <h3>üìù Create Test Notifications</h3>
                <div class="input-group">
                    <label for="notificationTitle">Title:</label>
                    <input type="text" id="notificationTitle" placeholder="Test Notification" value="SSE Test Notification">
                </div>
                
                <div class="input-group">
                    <label for="notificationMessage">Message:</label>
                    <input type="text" id="notificationMessage" placeholder="Test message" value="This is a test notification">
                </div>
                
                <div class="input-group">
                    <label for="notificationType">Type:</label>
                    <select id="notificationType">
                        <option value="test">Test</option>
                        <option value="task">Task</option>
                        <option value="announcement">Announcement</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="isUrgent"> Is Urgent
                    </label>
                </div>
                
                <div>
                    <button onclick="createNotification()" id="createBtn">üìù Create Notification</button>
                    <button onclick="createRandomNotification()">üé≤ Create Random</button>
                    <button onclick="clearCreateLog()">üóëÔ∏è Clear Log</button>
                </div>
                
                <div id="createLog" class="log">Ready to create notifications...</div>
            </div>
        </div>
        
        <!-- Full Width: Combined Testing -->
        <div class="section">
            <h3>üîÑ Combined Testing</h3>
            <p>Use this section to test the complete flow: Create notifications and see them appear in real-time via SSE.</p>
            <div>
                <button onclick="startCombinedTest()" id="combinedBtn">üöÄ Start Combined Test</button>
                <button onclick="stopCombinedTest()" id="stopBtn" disabled>‚èπÔ∏è Stop Test</button>
                <button onclick="clearCombinedLog()">üóëÔ∏è Clear Log</button>
            </div>
            <div id="combinedLog" class="log">Ready to start combined test...</div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let combinedTestInterval = null;
        let messageCount = 0;

        function log(message, type = 'info', logId = 'sseLog') {
            const logDiv = document.getElementById(logId);
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logDiv.appendChild(div);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearSSELog() {
            document.getElementById('sseLog').innerHTML = 'Ready to connect to SSE stream...';
        }

        function clearCreateLog() {
            document.getElementById('createLog').innerHTML = 'Ready to create notifications...';
        }

        function clearCombinedLog() {
            document.getElementById('combinedLog').innerHTML = 'Ready to start combined test...';
        }

        function updateSSEStatus(type, message) {
            const status = document.getElementById('sseStatus');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        function testSSE() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            
            if (!baseUrl || !token) {
                log('Please enter both Base URL and JWT Token', 'error');
                return;
            }
            
            if (eventSource) {
                eventSource.close();
            }
            
            updateSSEStatus('connecting', 'üîÑ Connecting to SSE...');
            document.getElementById('sseBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            
            log('Testing SSE connection...', 'info');
            
            const url = `${baseUrl}/api/notifications/stream`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'text/event-stream',
                    'Authorization': `Bearer ${token}`,
                    'Cache-Control': 'no-cache'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                updateSSEStatus('connected', '‚úÖ Connected to SSE Stream');
                log('‚úÖ SSE Connection established!', 'success');
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            log('Stream ended', 'info');
                            updateSSEStatus('disconnected', '‚ùå Stream ended');
                            document.getElementById('sseBtn').disabled = false;
                            document.getElementById('disconnectBtn').disabled = true;
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        lines.forEach(line => {
                            if (line.trim()) {
                                if (line.startsWith('event: ')) {
                                    log(`üì° Event: ${line.substring(7)}`, 'info');
                                } else if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.substring(6));
                                        log(`üì® Data: ${JSON.stringify(data, null, 2)}`, 'success');
                                        messageCount++;
                                    } catch (e) {
                                        log(`üì® Raw Data: ${line.substring(6)}`, 'success');
                                        messageCount++;
                                    }
                                }
                            }
                        });
                        
                        readStream();
                    }).catch(error => {
                        log(`‚ùå Stream error: ${error.message}`, 'error');
                        updateSSEStatus('disconnected', '‚ùå Stream error');
                        document.getElementById('sseBtn').disabled = false;
                        document.getElementById('disconnectBtn').disabled = true;
                    });
                }
                
                readStream();
                
            })
            .catch(error => {
                log(`‚ùå Connection failed: ${error.message}`, 'error');
                updateSSEStatus('disconnected', '‚ùå Connection failed');
                document.getElementById('sseBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
            });
        }

        function disconnectSSE() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            updateSSEStatus('disconnected', '‚ùå Disconnected');
            document.getElementById('sseBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            log('Manually disconnected', 'info');
        }

        function createNotification() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            const userId = document.getElementById('userId').value.trim();
            const title = document.getElementById('notificationTitle').value.trim();
            const message = document.getElementById('notificationMessage').value.trim();
            const type = document.getElementById('notificationType').value;
            const isUrgent = document.getElementById('isUrgent').checked;
            
            if (!baseUrl || !token || !userId || !title || !message) {
                log('Please fill in all required fields', 'error', 'createLog');
                return;
            }
            
            const notificationData = {
                user_id: userId,
                title: title,
                message: message,
                type: type,
                is_urgent: isUrgent
            };
            
            log('Creating notification...', 'info', 'createLog');
            
            // Try using the existing notifications endpoint with proper format
            fetch(`${baseUrl}/api/notifications`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    recipient_id: userId,
                    title: title,
                    message: message,
                    type: type,
                    is_urgent: isUrgent
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notificationId = data.data?.notification_id || data.data?.id || 'Unknown';
                    log(`‚úÖ Notification created successfully! ID: ${notificationId}`, 'success', 'createLog');
                } else {
                    log(`‚ùå Failed to create notification: ${data.error}`, 'error', 'createLog');
                }
            })
            .catch(error => {
                log(`‚ùå Error creating notification: ${error.message}`, 'error', 'createLog');
            });
        }

        function createRandomNotification() {
            const messages = [
                'New assignment posted!',
                'Class schedule updated',
                'Grade posted for your submission',
                'Important announcement from teacher',
                'Deadline reminder',
                'New class material available',
                'Attendance marked',
                'System maintenance scheduled'
            ];
            
            const types = ['task', 'announcement', 'grade', 'schedule', 'reminder'];
            
            document.getElementById('notificationTitle').value = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById('notificationMessage').value = `Random test message created at ${new Date().toLocaleTimeString()}`;
            document.getElementById('notificationType').value = types[Math.floor(Math.random() * types.length)];
            document.getElementById('isUrgent').checked = Math.random() > 0.7;
            
            createNotification();
        }

        function startCombinedTest() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const token = document.getElementById('token').value.trim();
            
            if (!baseUrl || !token) {
                log('Please enter both Base URL and JWT Token', 'error', 'combinedLog');
                return;
            }
            
            log('üöÄ Starting combined test...', 'info', 'combinedLog');
            log('1. First, connect to SSE stream', 'info', 'combinedLog');
            
            // Start SSE connection
            testSSE();
            
            // Wait a bit, then start creating notifications
            setTimeout(() => {
                log('2. Now creating test notifications every 5 seconds...', 'info', 'combinedLog');
                
                let counter = 1;
                combinedTestInterval = setInterval(() => {
                    if (counter > 5) {
                        stopCombinedTest();
                        return;
                    }
                    
                    document.getElementById('notificationTitle').value = `Combined Test ${counter}`;
                    document.getElementById('notificationMessage').value = `This is test notification ${counter} created at ${new Date().toLocaleTimeString()}`;
                    document.getElementById('notificationType').value = 'test';
                    document.getElementById('isUrgent').checked = counter % 3 === 0;
                    
                    createNotification();
                    log(`üìù Created test notification ${counter}/5`, 'info', 'combinedLog');
                    counter++;
                }, 5000);
                
            }, 2000);
            
            document.getElementById('combinedBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        }

        function stopCombinedTest() {
            if (combinedTestInterval) {
                clearInterval(combinedTestInterval);
                combinedTestInterval = null;
            }
            
            disconnectSSE();
            log('‚èπÔ∏è Combined test stopped', 'info', 'combinedLog');
            document.getElementById('combinedBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }

        // Auto-fill common deployment URLs
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('baseUrl')) {
                document.getElementById('baseUrl').value = urlParams.get('baseUrl');
            }
            if (urlParams.get('token')) {
                document.getElementById('token').value = urlParams.get('token');
            }
        });
    </script>
</body>
</html>
