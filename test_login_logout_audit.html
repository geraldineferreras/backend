<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Login/Logout Audit Logging</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
        #results {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 3px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Test Login/Logout Audit Logging</h1>
    
    <div class="test-section info">
        <h3>Instructions</h3>
        <p>This page tests the audit logging functionality for login and logout events. After each test, check the audit logs to verify the events were recorded.</p>
    </div>

    <div class="test-section">
        <h3>1. Test Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" value="admin@example.com">
        <input type="password" id="loginPassword" placeholder="Password" value="admin123">
        <button class="btn-primary" onclick="testLogin()">Test Login</button>
        <button class="btn-danger" onclick="testFailedLogin()">Test Failed Login</button>
    </div>

    <div class="test-section">
        <h3>2. Test Logout</h3>
        <button class="btn-success" onclick="testLogout()">Test Logout</button>
        <p><small>Note: You need to be logged in first (use the login test above)</small></p>
    </div>

    <div class="test-section">
        <h3>3. Check Audit Logs</h3>
        <button class="btn-primary" onclick="checkAuditLogs()">Get Audit Logs</button>
        <button class="btn-primary" onclick="checkAuthLogs()">Get Authentication Logs Only</button>
    </div>

    <div id="results"></div>

    <script>
        let currentToken = null;

        function log(message) {
            const results = document.getElementById('results');
            results.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                log('Testing login...');
                const response = await fetch('/scms_new_backup/index.php/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (data.status) {
                    currentToken = data.data.token;
                    log('✅ Login successful! Token: ' + currentToken.substring(0, 50) + '...');
                    log('Check audit logs for LOGGED IN event');
                } else {
                    log('❌ Login failed: ' + data.message);
                    log('Check audit logs for FAILED LOGIN event');
                }
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        async function testFailedLogin() {
            try {
                log('Testing failed login...');
                const response = await fetch('/scms_new_backup/index.php/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'invalid@example.com',
                        password: 'wrongpassword'
                    })
                });

                const data = await response.json();
                log('❌ Expected failed login: ' + data.message);
                log('Check audit logs for FAILED LOGIN event');
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        async function testLogout() {
            if (!currentToken) {
                log('❌ No token available. Please login first.');
                return;
            }

            try {
                log('Testing logout...');
                const response = await fetch('/scms_new_backup/index.php/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.status) {
                    currentToken = null;
                    log('✅ Logout successful!');
                    log('Check audit logs for LOGGED OUT event');
                } else {
                    log('❌ Logout failed: ' + data.message);
                }
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        async function checkAuditLogs() {
            if (!currentToken) {
                log('❌ No token available. Please login first.');
                return;
            }

            try {
                log('Fetching audit logs...');
                const response = await fetch('/scms_new_backup/index.php/api/admin/audit-logs?limit=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.status) {
                    log('✅ Audit logs retrieved:');
                    data.data.forEach(log => {
                        log(`- ${log.action_type} | ${log.module} | ${log.details} | ${log.created_at}`);
                    });
                } else {
                    log('❌ Failed to get audit logs: ' + data.message);
                }
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        async function checkAuthLogs() {
            if (!currentToken) {
                log('❌ No token available. Please login first.');
                return;
            }

            try {
                log('Fetching authentication logs...');
                const response = await fetch('/scms_new_backup/index.php/api/admin/audit-logs?module=AUTHENTICATION&limit=10', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + currentToken,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (data.status) {
                    log('✅ Authentication logs retrieved:');
                    data.data.forEach(log => {
                        log(`- ${log.action_type} | ${log.user_name} | ${log.details} | ${log.created_at}`);
                    });
                } else {
                    log('❌ Failed to get authentication logs: ' + data.message);
                }
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        }

        // Clear results on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('results').textContent = 'Test results will appear here...\n';
        });
    </script>
</body>
</html> 